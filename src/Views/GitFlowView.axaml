<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:m="using:SourceGit.Models"
             xmlns:vm="using:SourceGit.ViewModels"
             xmlns:v="using:SourceGit.Views"
             xmlns:c="using:SourceGit.Converters"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="400"
             x:Class="SourceGit.Views.GitFlowView"
             x:DataType="vm:Repository">
  <ItemsControl ItemsSource="{Binding GitFlowBranchGroups}"
                Background="Transparent">
    <ItemsControl.ItemsPanel>
      <ItemsPanelTemplate>
        <VirtualizingStackPanel Orientation="Vertical"/>
      </ItemsPanelTemplate>
    </ItemsControl.ItemsPanel>
    
    <ItemsControl.ItemTemplate>
      <DataTemplate DataType="m:GitFlowBranchGroup">
        <StackPanel Orientation="Vertical">
          <!-- Group Header -->
          <Grid Height="24" ColumnDefinitions="Auto,*,Auto" Background="Transparent">
            <Path Grid.Column="0" 
                  Width="10" 
                  Height="10" 
                  Margin="4,0,0,0"
                  VerticalAlignment="Center"
                  Data="{StaticResource Icons.Folder.Open}"
                  Fill="{DynamicResource Brush.FG2}"/>
            
            <TextBlock Grid.Column="1" 
                       Classes="primary"
                       FontWeight="SemiBold"
                       Margin="6,0,0,0"
                       VerticalAlignment="Center">
              <TextBlock.Text>
                <MultiBinding StringFormat="{}{0} ({1})">
                  <Binding Path="Name"/>
                  <Binding Path="Branches.Count"/>
                </MultiBinding>
              </TextBlock.Text>
            </TextBlock>
            
            <Button Grid.Column="2"
                    Classes="icon_button"
                    Width="14"
                    Height="14"
                    Margin="0,0,4,0"
                    Click="OnStartGitFlowBranch"
                    Tag="{Binding Type}"
                    ToolTip.Tip="{DynamicResource Text.GitFlow.StartNewBranch}">
              <Path Width="12" Height="12" Data="{StaticResource Icons.Branch.Add}"/>
            </Button>
          </Grid>
          
          <!-- Branch Items with Indentation -->
          <ListBox Classes="repo_left_content_list"
                   ItemsSource="{Binding Branches}"
                   SelectionMode="Single"
                   Margin="20,0,4,0"
                   Background="Transparent"
                   ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                   ScrollViewer.VerticalScrollBarVisibility="Disabled"
                   ContextRequested="OnBranchContextRequested"
                   DoubleTapped="OnBranchDoubleTapped">
            <ListBox.Styles>
              <Style Selector="ListBoxItem">
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="Padding" Value="4,0,4,0"/>
              </Style>
              
              <!-- Hide filter button by default, show on hover when no filter is active -->
              <Style Selector="ListBoxItem Button.filter_button">
                <Setter Property="IsVisible" Value="False"/>
              </Style>
              <Style Selector="ListBoxItem:pointerover Button.filter_button">
                <Setter Property="IsVisible" Value="True"/>
              </Style>
              
              <!-- Always show filter button when filter is active (via classes) -->
              <Style Selector="ListBoxItem.filter-active Button.filter_button">
                <Setter Property="IsVisible" Value="True"/>
              </Style>
            </ListBox.Styles>
            
            <ListBox.ItemTemplate>
              <DataTemplate DataType="m:Branch">
                <Grid ColumnDefinitions="Auto,*,Auto,32" Background="Transparent">
                  <Path Grid.Column="0" 
                        Width="10" 
                        Height="10" 
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Data="{StaticResource Icons.Branch}"
                        Fill="{DynamicResource Brush.FG2}"/>
                  
                  <TextBlock Grid.Column="1" 
                             Classes="primary"
                             Text="{Binding Name}"
                             FontWeight="{Binding IsCurrent, Converter={x:Static c:BoolConverters.IsBoldToFontWeight}}"
                             TextTrimming="CharacterEllipsis"
                             VerticalAlignment="Center"/>
                  
                  <Border Grid.Column="2"
                          Width="6" Height="6"
                          Margin="4,0,0,0"
                          CornerRadius="3"
                          Background="LimeGreen"
                          VerticalAlignment="Center"
                          IsVisible="{Binding IsCurrent}"
                          ToolTip.Tip="{DynamicResource Text.GitFlow.CurrentBranch}"/>
                  
                  <!-- Filter Mode Switcher (Eye Icon) -->
                  <Button Grid.Column="3"
                          Classes="icon_button filter_button"
                          Width="14" Height="14"
                          Margin="0,0,8,0"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Background="Transparent"
                          Padding="1"
                          Click="OnFilterButtonClicked"
                          Tag="{Binding}"
                          Name="FilterButton"
                          ToolTip.Tip="{DynamicResource Text.Repository.FilterCommits}">
                    <Grid>
                      <!-- Eye icon for no filter (visible on hover) -->
                      <Path Width="12" Height="12"
                            Name="FilterIconNone"
                            Data="{StaticResource Icons.Eye}"
                            Fill="{DynamicResource Brush.FG1}"
                            IsVisible="True"/>
                      
                      <!-- Filter icon for included mode -->
                      <Path Width="12" Height="12"
                            Name="FilterIconIncluded"
                            Data="{StaticResource Icons.Filter}"
                            Fill="{DynamicResource Brush.Accent}"
                            IsVisible="False"/>
                      
                      <!-- EyeClose icon for excluded mode -->
                      <Path Width="12" Height="12"
                            Name="FilterIconExcluded"
                            Data="{StaticResource Icons.EyeClose}"
                            Fill="{DynamicResource Brush.Accent}"
                            IsVisible="False"/>
                    </Grid>
                  </Button>
                </Grid>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </StackPanel>
      </DataTemplate>
    </ItemsControl.ItemTemplate>
  </ItemsControl>
</UserControl>